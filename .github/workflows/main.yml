name: VPS
on:
  workflow_dispatch:
jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: Install & Configure SSH
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server curl unzip
          sudo systemctl enable ssh
          sudo systemctl start ssh
          echo "root:12345" | sudo chpasswd
          echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
          echo "PasswordAuthentication yes" | sudo tee -a /etc/ssh/sshd_config
          sudo service ssh restart
          echo "‚úÖ SSH configured (user: root | pass: 12345)"

      - name: Install Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | \
            sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | \
            sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update -y
          sudo apt install -y ngrok

      - name: Connect Ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ngrok config add-authtoken $NGROK_AUTH_TOKEN
          nohup ngrok tcp 22 --region=eu > ngrok.log &
          sleep 5
          echo "üîÅ Waiting for ngrok to start..."
          sleep 10
          echo "‚úÖ Ngrok tunnel started"

      - name: Get Ngrok Public URL
        run: |
          url=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -o 'tcp://[0-9a-zA-Z:.]*')
          echo "üîó SSH via ngrok: $url"
          echo "User: root | Pass: 12345"
          echo "To connect, run:"
          echo ""
          echo "ssh root@<HOST> -p <PORT>"
          echo "Example:"
          echo "ssh root@${url#tcp://}"

      - name: Keep VPS Alive
        run: |
          while true; do
            echo "[$(date)] VPS running with ngrok..."
            sleep 300
          done
