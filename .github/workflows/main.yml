name: N8N VPS with Ngrok
on:
  workflow_dispatch:

jobs:
  n8n-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: üß± Setup environment
        run: |
          sudo apt update -y
          sudo apt install -y curl wget unzip openssh-server
          sudo systemctl enable ssh
          sudo systemctl start ssh
          echo "root:12345" | sudo chpasswd
          echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
          sudo service ssh restart
          echo "‚úÖ SSH ready ‚Äî user: root / pass: 12345"

      - name: ‚öôÔ∏è Install Node.js & n8n
        run: |
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt install -y nodejs
          sudo npm install -g n8n
          echo "‚úÖ n8n installed successfully!"

      - name: üöÄ Start n8n in background
        run: |
          nohup n8n start --port 5678 > n8n.log 2>&1 &
          sleep 10
          echo "‚úÖ n8n started on port 5678"

      - name: üåç Install & start Ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          curl -s https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip -o ngrok.zip
          unzip ngrok.zip
          sudo mv ngrok /usr/local/bin/
          ngrok config add-authtoken $NGROK_AUTH_TOKEN
          
          echo "üîÅ Starting Ngrok HTTP tunnel for n8n..."
          nohup ngrok http 5678 --log=stdout > ngrok.log &
          sleep 20
          
          echo "üåê Fetching public URL..."
          for i in {1..5}; do
            url=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -o 'https://[a-zA-Z0-9.-]*\.ngrok-free\.app' || true)
            if [ -n "$url" ]; then
              echo "‚úÖ Your n8n public URL: $url"
              echo "n8n_URL=$url" >> $GITHUB_ENV
              break
            fi
            echo "Waiting for ngrok tunnel..."
            sleep 5
          done
          if [ -z "$url" ]; then
            echo "‚ùå Could not retrieve ngrok URL. Check ngrok.log for details."
            cat ngrok.log
          fi

      - name: üîê Start Ngrok SSH tunnel
        run: |
          echo "üîÅ Starting SSH tunnel..."
          nohup ngrok tcp 22 --log=stdout > ngrok_ssh.log &
          sleep 15
          ssh_info=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -Eo "tcp://[0-9a-zA-Z\.\-:]*" | head -n 1 || true)
          if [ -n "$ssh_info" ]; then
            echo "‚úÖ SSH Access via: $ssh_info"
            echo "Use Termius or PuTTY with: root / 12345"
          else
            echo "‚ùå SSH tunnel not found."
            cat ngrok_ssh.log
          fi

      - name: üïê Keep VPS alive
        run: |
          echo "VPS running. Use Ctrl+C to stop manually."
          while true; do
            echo "[$(date)] Still alive..."
            sleep 300
          done
